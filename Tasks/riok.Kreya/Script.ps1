<#
{"Items":[{"Version":"1.17.0","Platform":"WINDOWS","Architecture":1,"Filename":"Kreya-win-x64.msi","DownloadLink":"https://stable-downloads.kreya.app/1.17.0/Kreya-win-x64.msi","DownloadSize":278544384,"Signature":"TzsZEIwDGbxWYMQV3iLh7IaUeGnomjau5b/Z1TkbBv4Pu0MaZCGielc/GjoaYgDJYYnGpYUXsQQJjNwmS39g4BdZotumDRn/wegbz5nBivaZnKj/2j9mybhIck9BbWWWKOUhoz3Ykfmf7d3X9C6tBEXg521x6C3kDxhcnohdKmsr4Gi3Uid2gr0Fily7gh5oAB1ts0j+FV79w6EMqL1fXn/WMFMXJAk+VCzs2j9ogN4OyJ83xqk6vKZSWbipuU/wAMdp9jNT8N5oZZwiQYWzk3QTH81pdTo4WViPbJ0E5lHdIkyplfs47iZebjeSQZ9NJQgrPdm+NDz3BFdg8iWpRw=="},{"Version":"1.17.0","Platform":"WINDOWS","Architecture":3,"Filename":"Kreya-win-arm64.msi","DownloadLink":"https://stable-downloads.kreya.app/1.17.0/Kreya-win-arm64.msi","DownloadSize":284983296,"Signature":"LmRoQqrHeM+rN1/imoFOZPk3/mcdKBLWM86HrpRD2ONC4N1bWI9ThYqEO07AFcijJoHTCKX0scICDfJ2cQBUY3hqLr3ZuAiWmAqNfbs/7oAeNlzgPHNj3aPbgQRjsFVbsyws/aqA8q9o+4R4Tq94W3+vySW0NP4/Ue0Mn7Z284p9TYX3MlE2w4cXJ3s5CYtmyNh94oz/V2Np9jLwNDoD6pLBvDraQ99z/Xs6yLLeG0yJftlVWlaoqxi3fDHMAYcEOQSAHC+FGX4ehvmmVC0v71vDFayzzizL00WGXi5Ol2Gty/wdlR0g+gj0qLZKMkAI9EymY5yRw8+knCrHSRE93w=="},{"Version":"1.17.0","Platform":"LINUX","Architecture":1,"Filename":"Kreya-linux-x64.tar.gz","DownloadLink":"https://stable-downloads.kreya.app/1.17.0/Kreya-linux-x64.tar.gz","DownloadSize":71488087,"Signature":"gs6TZO/ZkdEjXlF2rcknXxiHn+9VNhdnD7wjXIGylunNWKxb5mMkQl66cGRLD2zaJE3kmGt5Tk7T3JryLIG68t1eC7h+s858P2qTUPghJD+3PuIKLatPCnB6RSMblet+l4GF92FHbzfC2idefNZITZ6GAUfUcRRJ88vcbwlv/4a4VZpVEhDoEMdtfthD01icqQPB1BPJ2ORzfz4LG0P/AZIbXFXqhwb94LXEMpqy8ftaR2xMeKuxZvJs483GT2KqhJYutrMuqNIu1ETOv8RAg69DllcBtn99GPkx824n7RfBdrFVZeFsixKaK/J/6remfankgYPnUSmLLyKKlz3dJA=="},{"Version":"1.17.0","Platform":"LINUX","Architecture":3,"Filename":"Kreya-linux-arm64.tar.gz","DownloadLink":"https://stable-downloads.kreya.app/1.17.0/Kreya-linux-arm64.tar.gz","DownloadSize":68774048,"Signature":"UWvX460qDKWF8i+FwPxOrYvjz3kxhzeeKYwBU3ck37W+QQm+3qavl7dNU5Yb6lBY+DR9gw3Spb/6TXqMhhLIQu40FmBk0m8uD8qzr3jMdDhP2BQuA9ugkmYPb9pivP2p7XRIsMilrn1CRtopNJs2UDzdt5foNn0RfGFsgRnA5RsRC3XgDICls1RnFWDXEjT/1+TmkHi6BaFn/crJU+oxRmRNWPF/cyCfsInUgUbTOhLmaWG9jnuxEijXzRcylU/YxWs2L5UcE6HYffJYn/SR3OZjdJ8kbF04YCIWJGwU5q1lxnHb+R/BUBN8B65gJLlQtGM/xjsXVnAe3EjA87KeTA=="},{"Version":"1.17.0","Platform":"OSX","Architecture":1,"Filename":"Kreya-osx-x64.zip","DownloadLink":"https://stable-downloads.kreya.app/1.17.0/Kreya-osx-x64.zip","DownloadSize":69226811,"Signature":"UJBjno1cJ3WXVI0h2UzoSz+78FZWAOLql5IigwMBrfea13WlaM0IZTXbiyx9InTI7gN1r2z9Y0CewQI20SDj6ahpIBJeqhayM7zm7MjeFV5bHrQGDl/rwpqYOipLjmijH4ti8v0B7Kg5KCBGtNnXRdFxpCCSKE7/THaYOIQNbJumXDkhTe+Xe6gk8o0mh69+jtofrNqwThgoUqsHRnI08W0tmtXDViuiwVvogInDCotjJEtRYuFCg9yUVlHpbOpe3R59PIiIxGvtuOXzbUD6hWZxxUfcINHv7FBzgnIetDHI1ojW887nXtH/ElHTSTiokKQVgq1plg5t6YdYBIpJaw=="},{"Version":"1.17.0","Platform":"OSX","Architecture":3,"Filename":"Kreya-osx-arm64.zip","DownloadLink":"https://stable-downloads.kreya.app/1.17.0/Kreya-osx-arm64.zip","DownloadSize":62385618,"Signature":"K7lcoYIpurPwD0qDGjuJwdP4sx4tJP/QMS729yX63eMtt54G6CZIN3lPosctVTLoBMEOerT0mFMRi6MCzOVkHT6hU424Hs4WhrVDrwrbB4KIhzim6iiQn0XxoaXbU6kPuHMgiTg1s3wdUkZbwxbqbOtqprrbWkmQ854eD5Q8bddDTm58BNvA+Ka4rhqzwbBlobW77eyZ6sio5WtjgF7yigjmhKTWYsHDdR+CecGstk/3X3P0hUcNhy5zsY0ZBo0kxumPhyjOyq5q/ab3h774f2o1CWlX26NcYCLhgMwz7m1cbOTm7RMCAno6sDqrkFrYP/DX/yw+gg/r/i8xZXxf4g=="}]}
#>

$Object1 = Invoke-RestMethod -Uri 'https://stable-downloads.kreya.app/appcast.json'
# x64
$Object2 = $Object1.Items.Where({ $_.Platform -eq 'WINDOWS' -and $_.Architecture -eq 1 }, 'First')[0]
$VersionX64 = $Object2.Version
# arm64
$Object3 = $Object1.Items.Where({ $_.Platform -eq 'WINDOWS' -and $_.Architecture -eq 3 }, 'First')[0]
$VersionArm64 = $Object3.Version

if ($VersionX64 -ne $VersionArm64) {
  $this.Log("x64 version: ${VersionX64}")
  $this.Log("arm64 version: ${VersionArm64}")
  throw 'Inconsistent versions detected'
}

# Version
$this.CurrentState.Version = $VersionX64

# Installer
$this.CurrentState.Installer += [ordered]@{
  Architecture = 'x64'
  InstallerUrl = $Object2.DownloadLink
}
$this.CurrentState.Installer += [ordered]@{
  Architecture = 'arm64'
  InstallerUrl = $Object3.DownloadLink
}

switch -Regex ($this.Check()) {
  'New|Changed|Updated' {
    try {
      $Object2 = Invoke-WebRequest -Uri 'https://kreya.app/docs/release-notes/' | ConvertFrom-Html

      $ReleaseNotesTitleNode = $Object2.SelectSingleNode("//h2[contains(text(), '$($this.CurrentState.Version)')]")
      if ($ReleaseNotesTitleNode) {
        # ReleaseTime
        $this.CurrentState.ReleaseTime = [regex]::Match($ReleaseNotesTitleNode.InnerText, '(20\d{2}-\d{1,2}-\d{1,2})').Groups[1].Value | Get-Date -Format 'yyyy-MM-dd'

        # ReleaseNotes (en-US)
        $ReleaseNotesNodes = for ($Node = $ReleaseNotesTitleNode.NextSibling; $Node -and $Node.Name -ne 'h2'; $Node = $Node.NextSibling) { $Node }
        $this.CurrentState.Locale += [ordered]@{
          Locale = 'en-US'
          Key    = 'ReleaseNotes'
          Value  = $ReleaseNotesNodes | Get-TextContent | Format-Text
        }
      } else {
        $this.Log("No ReleaseTime and ReleaseNotes (en-US) for version $($this.CurrentState.Version)", 'Warning')
      }
    } catch {
      $_ | Out-Host
      $this.Log($_, 'Warning')
    }

    $this.Print()
    $this.Write()
  }
  'Changed|Updated' {
    $this.Message()
  }
  'Updated' {
    $this.Submit()
  }
}
